---
title: Visualización de datos
author: Samuel González
date: '2019-03-20'
slug: visualizacion-de-datos
categories:
  - Curso R
tags:
  - Ciencias Sociales
  - Datos
  - PISAC
  - R
  - tidyverse
  - ggplot2
  - visualizacion
---
```{r message=FALSE, warning=FALSE, include=FALSE}
# Primero abrimos la librería del paquete foreign
library(foreign)

# Importar bases
hogares <- read.spss("ENES_Hogares_version_final.sav", to.data.frame = TRUE)
personas <- read.spss("ENES_Personas_version_final.sav", to.data.frame = TRUE)
# Abrimos la libreria
library(dplyr)

# Ordenamos ambas bases con la funcion arrange 
hogares <- hogares %>% arrange(nocues, nhog)
personas <- personas %>% arrange(nocues, nhog)
# Emparejar bases
pisac <- personas %>% left_join(., hogares, by = c("nocues", "nhog"))
# el . llama al objeto que está antes del pipe
# Filtrar la base emparejada por la region NEA y seleccionar variables
NEA <- pisac %>% 
  filter(region.x == "NEA (Chaco, Corrientes, Formosa y Misiones)") %>% 
  select(v108, v109, v116, t_hogar, nivel_ed, v134a, 
estado, v179, nocues, nhog, f_calib3.x, region.x, aglo.x, v12, v14, v15, v16, v19, v235i, v237, v259a, v260a, v213bi)
# Renombrar variables
NEA <- NEA %>% rename(Edad = v108,
                      Sexo = v109,
                      Est_civil = v116)
# Ahora recategorizamos los valores
NEA <- NEA %>% mutate(Clase_recod = 
               case_when(v260a == "Clase baja" ~ "Clase baja",
                         v260a == "Clase obrera" ~ "Clase obrera",
                         v260a == "Clase media baja" ~ "Clase media",
                         v260a == "Clase media" ~ "Clase media",
                         v260a == "Clase media alta" ~ "Clase media",
                         v260a == "Clase alta" ~ "Clase alta",
                         v260a == "NS/NR" ~ "NS/NR"))
# Pasamos la nueva variable a factor y consultamos los valores para verificar 
NEA$Clase_recod <- as.factor(NEA$Clase_recod)
levels(NEA$Clase_recod)
# Convertimos los valores en NA
NEA$Edad[NEA$Edad == "Menor de un año" |
         NEA$Edad == "99 años y más"] <- NA

# Pasamos primero de factor a character
NEA$Edad <- as.character(NEA$Edad)

# Por ultimo pasamos a numérica
NEA$Edad <- as.numeric(NEA$Edad)
# Establecemos las categorías
NEA <- NEA %>% 
  mutate(Edad_recod = case_when(Edad %in% c(1:14) ~ "Menos de 15", 
                                Edad %in% c(15:26) ~"15 a 26",       
                                Edad %in% c(27:47) ~ "27 a 47",
                                Edad %in% c(48:97) ~ "48 a 97"))
```
```{r include=FALSE}
# Pasamos la nueva variable a factor y consultamos los valores para verificar 
NEA$Edad_recod <- as.factor(NEA$Edad_recod)
```

<div class=text-justify>
##Introducción
Luego de haber visto como manipular los datos disponibles en la base de datos del PISAC, en esta etapa del proceso del análisis de datos nos centraremos en la visualización, generando graficos de calidad utilizando el paquete **ggplot2** que forma parte del conjunto de paquetes que integran el tidyverse. Conoceremos la estructura de la sintaxis de este paquete y los argumentos necesarios para obtener los graficos que deseamos.

##Instalación
Si ya tinstalamos previamente el paquete tidyverse no es necesario volver a realizar otra instalación, de lo contrario debe instalar el paquete ggplot2:
```{r eval=FALSE, include=FALSE}
#Instalar paquete ggplot2
install.packages("ggplot2")
```
```{r,message=FALSE, warning=FALSE}
#y abrimos la librería
library(ggplot2)
#o abrimos el tidyverse
library(tidyverse)
```

##La gramática de los gráficos (ggplot)
La estructura básica de la función ggplot se compone por tres argumentos necesarios: ```data```, ```aes``` y ```geom```. De esta manera, en ```data``` indicamos el dataframe del cual vamos a seleccionar las variables para graficar. En ```aes``` indicamos el mapeo estético, es decir, qué variables vamos a graficar y en qué ejes. El argumento ```geom``` hace referencia a las capas geométricas, que a su vez, va a depender del tipo de gráfico que deseemos generar. Ejemplo: 
```{r, eval=FALSE}
ggplot(data= dataframe, aes(x= variable1, y= variable2)) + geom_point
```

#Gráfico de dispersión
Hagamos la prueba con un gráfico de dispersión utilizando las variables Ingreso neto de la Ocupación Principal (v213bi) y la Edad. Pero, previamente vamos a crear un nuevo dataframe que va a contener solamente las variables que necesitamos en el gráfico. Para ello usaremos el paquete dplyr.

```{r message=FALSE, warning=FALSE}
#Abrimos la librería
library(dplyr)
data.graf1 <- NEA %>% filter(v213bi > 0,                  #filtramos solo los ingresos mayores a 0
                             Edad >= 18,                  #y las edades mayores o iguales a 18 años
                             !is.na(Clase_recod)) %>%     #omitimos los casos NA en Clase_recod 
  select(v213bi, Edad, Sexo, Clase_recod) %>%             #seleccionamos otras variables que necesitaremos para graficar
  rename(Clase = Clase_recod)                             #cambiamos el nombre de la variable
```

Entonces, a partir de este dataframe vamos a realizar el grafico:
```{r}
ggplot(data= data.graf1, aes(x= Edad, y= v213bi)) + geom_point()
```

En un principio la estética del gráfico es bastante simple, pero podemos ir mejorando a nuestro gusto agregando más parámetros a la sintaxís de la función, utilizando siempre el símbolo ```+```.

#####Tabla 6
|Parámetro            | Resultado                |
|---------------------|--------------------------|
|labs()               | Etiquetas                |
|                     | title: titulo,           |
|                     | x: etiqueta eje x,       |
|                     | y: etiqueta eje y,       |
|                     | caption: subtítulo       |
|theme()              | tema del gráfico         |
|                     | base_family: fuente,     |
|                     | base_size: tamaño fuente,|
|scale_x_continuous() | Ajustar eje x            |
|scale_y_continuous() | Ajustar eje y            |
|geom_point()         | Gráfico de dispersión    |
|geom_bar()           | Gráfico de barras        |
|geom_histogram()     | Histograma               |
|geom_boxplot()       | Diagrama de caja         |
|geom_freqpoly()      | Polígono de frecuencia   |

En la *Tabla 6* se pueden ver sólo algunos de los parámetros de la función ggplot. Si desea apreciar el resto de las propiedades estéticas de los gráficos, puede consultar la *hoja de referencia* del paquete [aquí](https://www.rstudio.com/wp-content/uploads/2015/04/ggplot2-spanish.pdf).
Retomemos el gráfico anterior para mejorar su estética

```{r}
Grafico.1 <- ggplot(data= data.graf1, aes(x= Edad, y= v213bi)) + 
  geom_point(aes(color= Clase,              #agregamos una tercer variable
                 shape= Clase),             #formas geometricas de la nube
                 alpha= 0.8) +              #transparencia         
  scale_y_continuous(limits = c(0,40000)) + #ajustamos limites del eje y
  labs(title = "Distribución del Ingreso neto de la Ocupación Principal (IOP) de las personas 
según la edad y la clase social de pertenencia. NEA. 2015.",
       y= "IOP ($)",
       caption = "Fuente: elaboración propia en base al PISAC.") #agregamos etiquetas

Grafico.1
```

Observe que además de agregar argumentos a la función, guardamos el gráfico en un objeto llamado *Grafico.1*. Ahora podemos seguir agregando argumentos a partir de este objeto.
```{r}
Grafico.1 <- Grafico.1 + geom_smooth(method = lm, se = FALSE) +  #incorporamos la recta de ajuste
  theme_classic(base_family = "serif",     # agregamos un tema y modificamos la fuente
                base_size = 10)
Grafico.1
```

#Histograma
Vamos a crear un histograma utilizando la variable Ingreso neto de la Ocupación Principal, pero primeramente creamos el dataframe que necesitamos para graficar.
```{r}
data.graf2 <- NEA %>% filter(v213bi > 0,
                             !is.na(Clase_recod),
                             Edad_recod != "Menos de 15") %>% 
  select(v213bi, Edad_recod, Clase_recod, f_calib3.x) %>% 
  rename(Edad = Edad_recod)
```

Y graficamos en este caso usando ```geom_histogram```
```{r message=FALSE, warning=FALSE}
ggplot(data= data.graf2, aes(x= v213bi)) + geom_histogram()
```
Podemos expandir los casos usando el argumento ```weight```. Para esta base de datos, la variable ponderadora de casos es *factor de calibración* (f_calib3); por lo tanto, la incorporamos a la función y agregamos una segunda variable que es la Edad.
```{r echo=TRUE, message=FALSE, warning=FALSE}
ggplot(data= data.graf2, aes(x= v213bi, weight= f_calib3.x)) +
  geom_histogram(aes(fill = Edad),
                 color = "white") #las lineas en color blanco
```
Observe que ahora las frecuencias de las barras han aumentado porque se expandieron los casos, además las barras se dividen en función a los valores de la tercer variable Edad. También, como se habrá podido dar cuenta, las frecuencias de las barras del histograma están expresadas en valores absolutos. Si lo que deseamos es que las frecuencias se expresen valores porcentuales, necesitamos instalar adicionalmente el paquete ```scales```, que nos ayuda a modificar las escalas del eje y. 
```{r, eval=FALSE}
#Instalamos el paquete
install.packages("scales")
```
```{r echo=TRUE, message=FALSE, warning=FALSE}
#Abrimos la librería
library(scales)

#Ahora procedemos a modificar las frecuencias
Grafico.2 <- ggplot(data= data.graf2, aes(x= v213bi, weight= f_calib3.x)) +
  geom_histogram(aes(fill = Edad,
                     y= stat(..count..)/sum(..count..)*100), #con este argumento cambiamos a valores porcentuales
                 color = "white",
                 breaks = seq(0,40000, by= 2500)) #definimos la amplitud de los intervalos
Grafico.2
```
Modificamos los limites de los ejes, agregamos las etiquetas.
```{r}
Grafico.2 <- Grafico.2 + 
  scale_x_continuous(limits = c(0,40000)) +
  scale_y_continuous(limits = c(0,40)) +
  labs(title = "Distribución del Ingreso de la Ocupación Principal de las personas según la edad. NEA. 2015.",
       x= "IOP ($)",
       y= "Personas (%)",
       caption = "Fuente: elaboración propia en base a PISAC") +
  theme_bw(base_family = "serif",
           base_size = 10)
Grafico.2
```






**Aclaración: el contenido del post está en proceso de finalización...**
</div>
